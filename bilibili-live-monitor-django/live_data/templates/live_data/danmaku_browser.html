<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - Bilibili ç›´æ’­ç›‘æ§</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007cba;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007cba;
            color: white;
        }
        
        .btn-primary:hover {
            background: #005a8b;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .room-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .room-card:hover {
            transform: translateY(-5px);
        }
        
        .room-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .room-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .room-info h3 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        
        .room-info p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
        }
        
        .live-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-live {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-offline {
            background: #ffebee;
            color: #c62828;
        }
        
        .room-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .room-stat {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .room-stat-number {
            font-weight: bold;
            color: #007cba;
        }
        
        .room-stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .danmaku-section, .gifts-section {
            margin-top: 15px;
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007cba;
        }
        
        .danmaku-list, .gifts-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
            background: #fafafa;
        }
        
        .danmaku-item, .gift-item {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .danmaku-user, .gift-user {
            font-weight: bold;
            color: #007cba;
        }
        
        .danmaku-message {
            color: #333;
            margin-left: 5px;
        }
        
        .gift-info {
            color: #e91e63;
            font-weight: bold;
        }
        
        .timestamp {
            color: #999;
            font-size: 11px;
            float: right;
        }
        
        .error-card {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .refresh-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .refresh-indicator.error {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .no-data {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <div class="header">
            <h1>
                ğŸ¥ {{ page_title }}
                <span style="font-size: 14px; color: #666; font-weight: normal;">
                    {{ now|date:"Y-m-d H:i:s" }}
                </span>
            </h1>
            
            {% if error %}
                <div class="error-card">
                    <strong>âŒ é”™è¯¯:</strong> {{ error }}
                </div>
            {% else %}
                {% if system_stats %}
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">{{ total_rooms }}</div>
                        <div class="stat-label">æ€»æˆ¿é—´æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ active_rooms_count }}</div>
                        <div class="stat-label">æ´»è·ƒæˆ¿é—´</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ system_stats.total_danmaku|default:0 }}</div>
                        <div class="stat-label">æ€»å¼¹å¹•æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ system_stats.total_gifts|default:0 }}</div>
                        <div class="stat-label">æ€»ç¤¼ç‰©æ•°</div>
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div>
                    <a href="/live/" class="btn btn-primary">â† è¿”å›ä»ªè¡¨æ¿</a>
                    <button onclick="refreshData()" class="btn btn-success">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    <button onclick="toggleAutoRefresh()" class="btn btn-warning" id="autoRefreshBtn">
                        â° å¼€å¯è‡ªåŠ¨åˆ·æ–°
                    </button>
                    <button onclick="clearData()" class="btn btn-danger">ğŸ—‘ï¸ æ¸…ç©ºæ˜¾ç¤º</button>
                </div>
                
                <div class="auto-refresh">
                    <span>è‡ªåŠ¨åˆ·æ–°çŠ¶æ€:</span>
                    <div class="refresh-indicator" id="refreshIndicator"></div>
                    <span id="refreshStatus">å·²åœæ­¢</span>
                </div>
            </div>
        </div>
        
        <!-- æˆ¿é—´ç½‘æ ¼ -->
        <div id="roomsContainer">
            {% if not error %}
                <div class="loading">
                    <p>ğŸ“¡ æ­£åœ¨åŠ è½½å¼¹å¹•æ•°æ®...</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;
        let lastUpdateTime = null;

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        // æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´
        function getRelativeTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000);
            
            if (diff < 60) return `${diff}ç§’å‰`;
            if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`;
            return `${Math.floor(diff / 86400)}å¤©å‰`;
        }

        // åˆ›å»ºæˆ¿é—´å¡ç‰‡
        function createRoomCard(roomData) {
            const room = roomData.room_info;
            const danmaku = roomData.recent_danmaku || [];
            const gifts = roomData.recent_gifts || [];
            
            const statusClass = room.live_status === 1 ? 'status-live' : 'status-offline';
            const statusText = room.live_status === 1 ? 'ğŸ”´ ç›´æ’­ä¸­' : 'âš« ç¦»çº¿';
            
            let danmakuHtml = '';
            if (danmaku.length > 0) {
                danmakuHtml = danmaku.map(d => `
                    <div class="danmaku-item">
                        <span class="danmaku-user">${d.username || 'åŒ¿å'}</span>
                        <span class="danmaku-message">${d.message || ''}</span>
                        <span class="timestamp">${getRelativeTime(d.timestamp)}</span>
                    </div>
                `).join('');
            } else {
                danmakuHtml = '<div class="no-data">æš‚æ— å¼¹å¹•æ•°æ®</div>';
            }
            
            let giftsHtml = '';
            if (gifts.length > 0) {
                giftsHtml = gifts.map(g => `
                    <div class="gift-item">
                        <span class="gift-user">${g.username || 'åŒ¿å'}</span>
                        <span class="gift-info">é€å‡º ${g.gift_name || 'ç¤¼ç‰©'} x${g.gift_count || 1}</span>
                        <span class="timestamp">${getRelativeTime(g.timestamp)}</span>
                    </div>
                `).join('');
            } else {
                giftsHtml = '<div class="no-data">æš‚æ— ç¤¼ç‰©æ•°æ®</div>';
            }
            
            return `
                <div class="room-card">
                    <div class="room-header">
                        <img src="${room.face || '/static/default-avatar.png'}" 
                             alt="${room.uname || 'ä¸»æ’­'}" 
                             class="room-avatar"
                             onerror="this.src='/static/default-avatar.png'">
                        <div class="room-info">
                            <h3>
                                <a href="/live/room/${room.room_id}/" style="text-decoration: none; color: inherit;">
                                    ${room.uname || `ä¸»æ’­${room.room_id}`}
                                </a>
                                <span class="live-status ${statusClass}">${statusText}</span>
                            </h3>
                            <p>${(room.title || 'æ— æ ‡é¢˜').substring(0, 50)}${room.title && room.title.length > 50 ? '...' : ''}</p>
                            <p style="font-size: 12px;">æˆ¿é—´å·: ${room.room_id} | åˆ†åŒº: ${room.area_name || 'æœªçŸ¥'}</p>
                        </div>
                    </div>
                    
                    <div class="room-stats">
                        <div class="room-stat">
                            <div class="room-stat-number">${room.online || 0}</div>
                            <div class="room-stat-label">åœ¨çº¿äººæ•°</div>
                        </div>
                        <div class="room-stat">
                            <div class="room-stat-number">${room.danmaku_count || 0}</div>
                            <div class="room-stat-label">å¼¹å¹•æ•°</div>
                        </div>
                        <div class="room-stat">
                            <div class="room-stat-number">${room.gift_count || 0}</div>
                            <div class="room-stat-label">ç¤¼ç‰©æ•°</div>
                        </div>
                    </div>
                    
                    <div class="danmaku-section">
                        <div class="section-title">ğŸ’¬ æœ€æ–°å¼¹å¹•</div>
                        <div class="danmaku-list">${danmakuHtml}</div>
                    </div>
                    
                    <div class="gifts-section">
                        <div class="section-title">ğŸ æœ€æ–°ç¤¼ç‰©</div>
                        <div class="gifts-list">${giftsHtml}</div>
                    </div>
                </div>
            `;
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                updateRefreshStatus('loading', 'æ­£åœ¨åŠ è½½...');
                
                const response = await fetch('/live/api/danmaku-browser/');
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('roomsContainer');
                    
                    if (data.data.rooms && data.data.rooms.length > 0) {
                        const roomsHtml = data.data.rooms.map(createRoomCard).join('');
                        container.innerHTML = `<div class="rooms-grid">${roomsHtml}</div>`;
                    } else {
                        container.innerHTML = `
                            <div class="no-data" style="text-align: center; padding: 40px;">
                                <h3>ğŸ“­ æš‚æ— æ´»è·ƒæˆ¿é—´</h3>
                                <p>å½“å‰æ²¡æœ‰æˆ¿é—´åœ¨ç›´æ’­æˆ–äº§ç”Ÿå¼¹å¹•æ•°æ®</p>
                                <button onclick="refreshData()" class="btn btn-primary">é‡æ–°åŠ è½½</button>
                            </div>
                        `;
                    }
                    
                    lastUpdateTime = new Date();
                    updateRefreshStatus('success', `æˆåŠŸåŠ è½½ ${data.data.rooms.length} ä¸ªæˆ¿é—´`);
                } else {
                    throw new Error(data.error || 'æ•°æ®åŠ è½½å¤±è´¥');
                }
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                updateRefreshStatus('error', `åŠ è½½å¤±è´¥: ${error.message}`);
                
                document.getElementById('roomsContainer').innerHTML = `
                    <div class="error-card">
                        <h3>âŒ æ•°æ®åŠ è½½å¤±è´¥</h3>
                        <p>${error.message}</p>
                        <button onclick="refreshData()" class="btn btn-primary">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // æ›´æ–°åˆ·æ–°çŠ¶æ€
        function updateRefreshStatus(status, message) {
            const indicator = document.getElementById('refreshIndicator');
            const statusText = document.getElementById('refreshStatus');
            
            indicator.className = 'refresh-indicator';
            
            if (status === 'loading') {
                indicator.classList.add('loading');
                statusText.textContent = message;
            } else if (status === 'success') {
                statusText.textContent = `${message} (${formatTime(new Date())})`;
            } else if (status === 'error') {
                indicator.classList.add('error');
                statusText.textContent = message;
            }
        }

        // æ‰‹åŠ¨åˆ·æ–°
        function refreshData() {
            loadData();
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefreshEnabled) {
                clearInterval(autoRefreshInterval);
                isAutoRefreshEnabled = false;
                btn.textContent = 'â° å¼€å¯è‡ªåŠ¨åˆ·æ–°';
                btn.className = 'btn btn-warning';
                updateRefreshStatus('', 'å·²åœæ­¢');
            } else {
                autoRefreshInterval = setInterval(loadData, 10000); // 10ç§’åˆ·æ–°
                isAutoRefreshEnabled = true;
                btn.textContent = 'â¸ï¸ åœæ­¢è‡ªåŠ¨åˆ·æ–°';
                btn.className = 'btn btn-danger';
                updateRefreshStatus('success', 'è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨');
                loadData(); // ç«‹å³åŠ è½½ä¸€æ¬¡
            }
        }

        // æ¸…ç©ºæ˜¾ç¤º
        function clearData() {
            document.getElementById('roomsContainer').innerHTML = `
                <div class="no-data" style="text-align: center; padding: 40px;">
                    <h3>ğŸ—‘ï¸ æ•°æ®å·²æ¸…ç©º</h3>
                    <p>ç‚¹å‡»åˆ·æ–°æŒ‰é’®é‡æ–°åŠ è½½æ•°æ®</p>
                    <button onclick="refreshData()" class="btn btn-primary">é‡æ–°åŠ è½½</button>
                </div>
            `;
            updateRefreshStatus('', 'æ•°æ®å·²æ¸…ç©º');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å¼¹å¹•æµè§ˆå™¨é¡µé¢åŠ è½½å®Œæˆ');
            
            // å»¶è¿Ÿ1ç§’ååŠ è½½æ•°æ®ï¼Œç¡®ä¿é¡µé¢æ¸²æŸ“å®Œæˆ
            setTimeout(loadData, 1000);
        });

        // é¡µé¢å³å°†å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>