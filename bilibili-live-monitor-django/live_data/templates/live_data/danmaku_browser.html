<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - Bilibili Áõ¥Êí≠ÁõëÊéß</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007cba;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007cba;
            color: white;
        }
        
        .btn-primary:hover {
            background: #005a8b;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .room-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .room-card:hover {
            transform: translateY(-5px);
        }
        
        .room-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .room-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .room-info h3 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        
        .room-info p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
        }
        
        .live-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-live {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-offline {
            background: #ffebee;
            color: #c62828;
        }
        
        .room-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .room-stat {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .room-stat-number {
            font-weight: bold;
            color: #007cba;
        }
        
        .room-stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .danmaku-section, .gifts-section {
            margin-top: 15px;
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007cba;
        }
        
        .danmaku-list, .gifts-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
            background: #fafafa;
        }
        
        .danmaku-item, .gift-item {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .danmaku-user, .gift-user {
            font-weight: bold;
            color: #007cba;
        }
        
        .danmaku-message {
            color: #333;
            margin-left: 5px;
        }
        
        .gift-info {
            color: #e91e63;
            font-weight: bold;
        }
        
        .timestamp {
            color: #999;
            font-size: 11px;
            float: right;
        }
        
        .error-card {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .refresh-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .refresh-indicator.error {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .no-data {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â§¥ÈÉ®‰ø°ÊÅØ -->
        <div class="header">
            <h1>
                üé• {{ page_title }}
                <span style="font-size: 14px; color: #666; font-weight: normal;">
                    {{ now|date:"Y-m-d H:i:s" }}
                </span>
            </h1>
            
            {% if error %}
                <div class="error-card">
                    <strong>‚ùå ÈîôËØØ:</strong> {{ error }}
                </div>
            {% else %}
                {% if system_stats %}
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">{{ total_rooms }}</div>
                        <div class="stat-label">ÊÄªÊàøÈó¥Êï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ active_rooms_count }}</div>
                        <div class="stat-label">Ê¥ªË∑ÉÊàøÈó¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ system_stats.total_danmaku|default:0 }}</div>
                        <div class="stat-label">ÊÄªÂºπÂπïÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ system_stats.total_gifts|default:0 }}</div>
                        <div class="stat-label">ÊÄªÁ§ºÁâ©Êï∞</div>
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
        
        <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="controls">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div>
                    <a href="/live/" class="btn btn-primary">‚Üê ËøîÂõû‰ª™Ë°®Êùø</a>
                    <button onclick="refreshData()" class="btn btn-success">üîÑ Âà∑Êñ∞Êï∞ÊçÆ</button>
                    <button onclick="toggleAutoRefresh()" class="btn btn-warning" id="autoRefreshBtn">
                        ‚è∞ ÂºÄÂêØËá™Âä®Âà∑Êñ∞
                    </button>
                    <button onclick="clearData()" class="btn btn-danger">üóëÔ∏è Ê∏ÖÁ©∫ÊòæÁ§∫</button>
                </div>
                
                <div class="auto-refresh">
                    <span>Ëá™Âä®Âà∑Êñ∞Áä∂ÊÄÅ:</span>
                    <div class="refresh-indicator" id="refreshIndicator"></div>
                    <span id="refreshStatus">Â∑≤ÂÅúÊ≠¢</span>
                </div>
            </div>
        </div>
        
        <!-- ÊàøÈó¥ÁΩëÊ†º -->
        <div id="roomsContainer">
            {% if not error %}
                <div class="loading">
                    <p>üì° Ê≠£Âú®Âä†ËΩΩÂºπÂπïÊï∞ÊçÆ...</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;
        let lastUpdateTime = null;

        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        // Ê†ºÂºèÂåñÁõ∏ÂØπÊó∂Èó¥
        function getRelativeTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000);
            
            if (diff < 60) return `${diff}ÁßíÂâç`;
            if (diff < 3600) return `${Math.floor(diff / 60)}ÂàÜÈíüÂâç`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}Â∞èÊó∂Ââç`;
            return `${Math.floor(diff / 86400)}Â§©Ââç`;
        }

        // ÂàõÂª∫ÊàøÈó¥Âç°Áâá
        function createRoomCard(roomData) {
            const room = roomData.room_info;
            const danmaku = roomData.recent_danmaku || [];
            const gifts = roomData.recent_gifts || [];
            
            const statusClass = room.live_status === 1 ? 'status-live' : 'status-offline';
            const statusText = room.live_status === 1 ? 'üî¥ Áõ¥Êí≠‰∏≠' : '‚ö´ Á¶ªÁ∫ø';
            
            let danmakuHtml = '';
            if (danmaku.length > 0) {
                danmakuHtml = danmaku.map(d => `
                    <div class="danmaku-item">
                        <span class="danmaku-user">${d.username || 'ÂåøÂêç'}</span>
                        <span class="danmaku-message">${d.message || ''}</span>
                        <span class="timestamp">${getRelativeTime(d.timestamp)}</span>
                    </div>
                `).join('');
            } else {
                danmakuHtml = '<div class="no-data">ÊöÇÊó†ÂºπÂπïÊï∞ÊçÆ</div>';
            }
            
            let giftsHtml = '';
            if (gifts.length > 0) {
                giftsHtml = gifts.map(g => `
                    <div class="gift-item">
                        <span class="gift-user">${g.username || 'ÂåøÂêç'}</span>
                        <span class="gift-info">ÈÄÅÂá∫ ${g.gift_name || 'Á§ºÁâ©'} x${g.gift_count || 1}</span>
                        <span class="timestamp">${getRelativeTime(g.timestamp)}</span>
                    </div>
                `).join('');
            } else {
                giftsHtml = '<div class="no-data">ÊöÇÊó†Á§ºÁâ©Êï∞ÊçÆ</div>';
            }
            
            return `
                <div class="room-card">
                    <div class="room-header">
                        <img src="${room.face || '/static/default-avatar.png'}" 
                             alt="${room.uname || '‰∏ªÊí≠'}" 
                             class="room-avatar"
                             onerror="this.src='/static/default-avatar.png'">
                        <div class="room-info">
                            <h3>
                                <a href="/live/room/${room.room_id}/" style="text-decoration: none; color: inherit;">
                                    ${room.uname || `‰∏ªÊí≠${room.room_id}`}
                                </a>
                                <span class="live-status ${statusClass}">${statusText}</span>
                            </h3>
                            <p>${(room.title || 'Êó†Ê†áÈ¢ò').substring(0, 50)}${room.title && room.title.length > 50 ? '...' : ''}</p>
                            <p style="font-size: 12px;">ÊàøÈó¥Âè∑: ${room.room_id} | ÂàÜÂå∫: ${room.area_name || 'Êú™Áü•'}</p>
                        </div>
                    </div>
                    
                    <div class="room-stats">
                        <div class="room-stat">
                            <div class="room-stat-number">${room.online || 0}</div>
                            <div class="room-stat-label">Âú®Á∫ø‰∫∫Êï∞</div>
                        </div>
                        <div class="room-stat">
                            <div class="room-stat-number">${room.danmaku_count || 0}</div>
                            <div class="room-stat-label">ÂºπÂπïÊï∞</div>
                        </div>
                        <div class="room-stat">
                            <div class="room-stat-number">${room.gift_count || 0}</div>
                            <div class="room-stat-label">Á§ºÁâ©Êï∞</div>
                        </div>
                    </div>
                    
                    <div class="danmaku-section">
                        <div class="section-title">üí¨ ÊúÄÊñ∞ÂºπÂπï</div>
                        <div class="danmaku-list">${danmakuHtml}</div>
                    </div>
                    
                    <div class="gifts-section">
                        <div class="section-title">üéÅ ÊúÄÊñ∞Á§ºÁâ©</div>
                        <div class="gifts-list">${giftsHtml}</div>
                    </div>
                </div>
            `;
        }

        // Âä†ËΩΩÊï∞ÊçÆ
        async function loadData() {
            try {
                updateRefreshStatus('loading', 'Ê≠£Âú®Âä†ËΩΩ...');
                
                const response = await fetch('/live/api/danmaku-browser/');
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('roomsContainer');
                    
                    if (data.data.rooms && data.data.rooms.length > 0) {
                        const roomsHtml = data.data.rooms.map(createRoomCard).join('');
                        container.innerHTML = `<div class="rooms-grid">${roomsHtml}</div>`;
                    } else {
                        container.innerHTML = `
                            <div class="no-data" style="text-align: center; padding: 40px;">
                                <h3>üì≠ ÊöÇÊó†Ê¥ªË∑ÉÊàøÈó¥</h3>
                                <p>ÂΩìÂâçÊ≤°ÊúâÊàøÈó¥Âú®Áõ¥Êí≠Êàñ‰∫ßÁîüÂºπÂπïÊï∞ÊçÆ</p>
                                <button onclick="refreshData()" class="btn btn-primary">ÈáçÊñ∞Âä†ËΩΩ</button>
                            </div>
                        `;
                    }
                    
                    lastUpdateTime = new Date();
                    updateRefreshStatus('success', `ÊàêÂäüÂä†ËΩΩ ${data.data.rooms.length} ‰∏™ÊàøÈó¥`);
                } else {
                    throw new Error(data.error || 'Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•');
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
                updateRefreshStatus('error', `Âä†ËΩΩÂ§±Ë¥•: ${error.message}`);
                
                document.getElementById('roomsContainer').innerHTML = `
                    <div class="error-card">
                        <h3>‚ùå Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</h3>
                        <p>${error.message}</p>
                        <button onclick="refreshData()" class="btn btn-primary">ÈáçËØï</button>
                    </div>
                `;
            }
        }

        // Êõ¥Êñ∞Âà∑Êñ∞Áä∂ÊÄÅ
        function updateRefreshStatus(status, message) {
            const indicator = document.getElementById('refreshIndicator');
            const statusText = document.getElementById('refreshStatus');
            
            indicator.className = 'refresh-indicator';
            
            if (status === 'loading') {
                indicator.classList.add('loading');
                statusText.textContent = message;
            } else if (status === 'success') {
                statusText.textContent = `${message} (${formatTime(new Date())})`;
            } else if (status === 'error') {
                indicator.classList.add('error');
                statusText.textContent = message;
            }
        }

        // ÊâãÂä®Âà∑Êñ∞
        function refreshData() {
            loadData();
        }

        // ÂàáÊç¢Ëá™Âä®Âà∑Êñ∞
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefreshEnabled) {
                clearInterval(autoRefreshInterval);
                isAutoRefreshEnabled = false;
                btn.textContent = '‚è∞ ÂºÄÂêØËá™Âä®Âà∑Êñ∞';
                btn.className = 'btn btn-warning';
                updateRefreshStatus('', 'Â∑≤ÂÅúÊ≠¢');
            } else {
                autoRefreshInterval = setInterval(loadData, 10000); // 10ÁßíÂà∑Êñ∞
                isAutoRefreshEnabled = true;
                btn.textContent = '‚è∏Ô∏è ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞';
                btn.className = 'btn btn-danger';
                updateRefreshStatus('success', 'Ëá™Âä®Âà∑Êñ∞Â∑≤ÂêØÁî®');
                loadData(); // Á´ãÂç≥Âä†ËΩΩ‰∏ÄÊ¨°
            }
        }

        // Ê∏ÖÁ©∫ÊòæÁ§∫
        function clearData() {
            document.getElementById('roomsContainer').innerHTML = `
                <div class="no-data" style="text-align: center; padding: 40px;">
                    <h3>üóëÔ∏è Êï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫</h3>
                    <p>ÁÇπÂáªÂà∑Êñ∞ÊåâÈíÆÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ</p>
                    <button onclick="refreshData()" class="btn btn-primary">ÈáçÊñ∞Âä†ËΩΩ</button>
                </div>
            `;
            updateRefreshStatus('', 'Êï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫');
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ÂºπÂπïÊµèËßàÂô®È°µÈù¢Âä†ËΩΩÂÆåÊàê');
            
            // Âª∂Ëøü1ÁßíÂêéÂä†ËΩΩÊï∞ÊçÆÔºåÁ°Æ‰øùÈ°µÈù¢Ê∏≤ÊüìÂÆåÊàê
            setTimeout(loadData, 1000);
        });

        // È°µÈù¢Âç≥Â∞ÜÂç∏ËΩΩÊó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>